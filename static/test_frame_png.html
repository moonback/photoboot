<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cadre PNG</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: white;
        }

        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #444;
            border-radius: 8px;
            background: #2a2a2a;
        }

        canvas {
            border: 2px solid #666;
            margin: 10px;
            background: #333;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }

        button:hover {
            background: #0056b3;
        }

        .log {
            background: #1e1e1e;
            border: 1px solid #444;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
            color: #00ff00;
        }

        .canvas-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .canvas-wrapper {
            text-align: center;
        }

        .canvas-wrapper h4 {
            margin-bottom: 10px;
            color: #007bff;
        }

        .info-box {
            background: #333;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #555;
            margin: 15px 0;
        }

        .info-box h3 {
            margin-top: 0;
            color: #007bff;
        }
    </style>
</head>

<body>
    <h1>üß™ Test Cadre PNG</h1>
    <p>Ce test v√©rifie que le cadre s'enregistre bien en PNG avec transparence.</p>

    <div class="test-section">
        <h2>1. R√©cup√©ration du Cadre Actif</h2>
        <button onclick="testGetActiveFrame()">R√©cup√©rer le cadre actif</button>
        <div id="frame-info" class="log"></div>
    </div>

    <div class="test-section">
        <h2>2. Test d'Application du Cadre</h2>
        <button onclick="testFrameApplication()">Tester l'application du cadre</button>
        <div id="test-result" class="log"></div>
    </div>

    <div class="test-section">
        <h2>3. R√©sultats</h2>
        <div class="canvas-container">
            <div class="canvas-wrapper">
                <h4>Photo Originale</h4>
                <canvas id="original-canvas" width="400" height="300"></canvas>
            </div>
            <div class="canvas-wrapper">
                <h4>Photo avec Cadre</h4>
                <canvas id="frame-canvas" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>4. Informations Techniques</h2>
        <div class="info-box">
            <h3>Format de Sortie</h3>
            <p><strong>Format :</strong> PNG (avec transparence)</p>
            <p><strong>Qualit√© :</strong> 100% (sans perte)</p>
            <p><strong>Mode :</strong> Bord √† bord (100%)</p>
        </div>
        <div class="info-box">
            <h3>D√©tails du Cadre</h3>
            <div id="frame-details"></div>
        </div>
    </div>

    <script>
        let activeFrame = null;

        // Cr√©er une photo d'exemple avec des couleurs vives
        function createSamplePhoto() {
            const canvas = document.getElementById('original-canvas');
            const ctx = canvas.getContext('2d');

            // Cr√©er un motif ray√© color√©
            const stripeHeight = 25;
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#ffd93d', '#ff8e8e', '#a8e6cf'];

            for (let y = 0; y < canvas.height; y += stripeHeight) {
                const colorIndex = Math.floor(y / stripeHeight) % colors.length;
                ctx.fillStyle = colors[colorIndex];
                ctx.fillRect(0, y, canvas.width, stripeHeight);
            }

            // Ajouter du texte
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('PHOTO TEST', canvas.width / 2, canvas.height / 2);

            // Ajouter des formes g√©om√©triques
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(canvas.width / 2, canvas.height / 2 + 40, 25, 0, 2 * Math.PI);
            ctx.fill();

            ctx.fillStyle = 'white';
            ctx.fillRect(canvas.width / 2 - 30, canvas.height / 2 + 70, 60, 20);

            return canvas;
        }

        async function testGetActiveFrame() {
            const logElement = document.getElementById('frame-info');
            logElement.textContent = 'R√©cup√©ration du cadre actif...';

            try {
                const response = await fetch('/admin/frames/active');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                activeFrame = data.frame;

                if (activeFrame) {
                    logElement.textContent = `‚úÖ Cadre actif trouv√©:\n${JSON.stringify(activeFrame, null, 2)}`;
                    displayFrameDetails();
                } else {
                    logElement.textContent = '‚ùå Aucun cadre actif trouv√©';
                }
            } catch (error) {
                logElement.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        function displayFrameDetails() {
            if (!activeFrame) return;

            document.getElementById('frame-details').innerHTML = `
                <p><strong>Nom :</strong> ${activeFrame.name}</p>
                <p><strong>Dimensions :</strong> ${activeFrame.width} x ${activeFrame.height} pixels</p>
                <p><strong>Position :</strong> ${activeFrame.position}</p>
                <p><strong>Taille :</strong> ${activeFrame.size}%</p>
                <p><strong>Fichier :</strong> ${activeFrame.filename}</p>
            `;
        }

        async function testFrameApplication() {
            if (!activeFrame) {
                alert('Veuillez d\'abord r√©cup√©rer le cadre actif');
                return;
            }

            const logElement = document.getElementById('test-result');
            logElement.textContent = 'Test d\'application du cadre en cours...';

            try {
                // Cr√©er la photo d'exemple
                const sampleCanvas = createSamplePhoto();

                // Appliquer le cadre
                const result = await applyFrameWithPNG(sampleCanvas, activeFrame);

                if (result) {
                    const frameCanvas = document.getElementById('frame-canvas');
                    const frameCtx = frameCanvas.getContext('2d');

                    // Afficher le r√©sultat
                    frameCtx.drawImage(result, 0, 0, frameCanvas.width, frameCanvas.height);

                    logElement.textContent = `‚úÖ Test r√©ussi!\nCadre appliqu√© en PNG avec transparence\nV√©rifiez que la photo est visible √† travers le cadre`;
                }
            } catch (error) {
                logElement.textContent = `‚ùå Erreur lors du test: ${error.message}`;
            }
        }

        async function applyFrameWithPNG(photoCanvas, frame) {
            return new Promise((resolve, reject) => {
                try {
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');

                    // D√©finir la taille du canvas temporaire
                    tempCanvas.width = photoCanvas.width;
                    tempCanvas.height = photoCanvas.height;

                    // Dessiner la photo originale
                    tempCtx.drawImage(photoCanvas, 0, 0);

                    // Charger le cadre
                    const frameImg = new Image();
                    frameImg.onload = () => {
                        try {
                            const photoWidth = photoCanvas.width;
                            const photoHeight = photoCanvas.height;

                            console.log('=== D√âBOGAGE PNG ===');
                            console.log('Dimensions photo:', photoWidth, 'x', photoHeight);
                            console.log('Dimensions cadre:', frame.width, 'x', frame.height);
                            console.log('Taille:', frame.size + '%');
                            console.log('Format de sortie: PNG');
                            console.log('========================');

                            // Appliquer le cadre en mode bord √† bord (100%)
                            // Le cadre doit couvrir toute la photo
                            tempCtx.drawImage(frameImg, 0, 0, photoWidth, photoHeight);

                            // Convertir en PNG pour pr√©server la transparence
                            tempCanvas.toBlob((blob) => {
                                if (blob) {
                                    console.log('‚úÖ Image cr√©√©e en PNG, taille:', blob.size, 'bytes');
                                    const url = URL.createObjectURL(blob);
                                    const img = new Image();
                                    img.onload = () => {
                                        resolve(img);
                                    };
                                    img.src = url;
                                } else {
                                    reject(new Error('Erreur lors de la conversion en PNG'));
                                }
                            }, 'image/png', 1.0);

                        } catch (error) {
                            reject(error);
                        }
                    };

                    frameImg.onerror = () => {
                        reject(new Error('Erreur lors du chargement du cadre'));
                    };

                    frameImg.src = `/frames/${frame.filename}`;

                } catch (error) {
                    reject(error);
                }
            });
        }

        // Initialisation
        window.onload = function () {
            createSamplePhoto();
        };
    </script>
</body>

</html>